{% extends "accounts/base_modern.html" %}

{% block title %}{{ title }} - Transport Intelligent{% endblock %}

{% block content %}
<div class="mx-auto max-w-4xl space-y-6 p-6">
    <!-- Header -->
    <div class="rounded-2xl border border-gray-200 bg-white p-8">
        <h1 class="mb-2 text-3xl font-bold text-gray-900">
            <i class="fas fa-route mr-3 text-brand-600"></i>{{ title }}
        </h1>
        <p class="text-gray-600">Remplissez les informations du trajet</p>
    </div>

    <!-- Form -->
    <div class="rounded-2xl border border-gray-200 bg-white p-8">
        <form method="post" class="space-y-6">
            {% csrf_token %}
            
            <!-- Nom du trajet (optionnel) -->
            <div>
                <label for="nom_trajet" class="block text-sm font-medium text-gray-700 mb-2">
                    Nom du trajet <span class="text-gray-400">(optionnel)</span>
                </label>
                <input type="text" name="nom_trajet" id="nom_trajet"
                       class="w-full rounded-lg border border-gray-300 px-4 py-2 focus:border-brand-500 focus:ring-brand-500"
                       placeholder="Ex: Trajet Matinal, Ligne 1, etc.">
                <p class="mt-1 text-sm text-gray-500">Si non renseigné, un nom sera généré automatiquement</p>
            </div>

            <!-- Station de départ -->
            <div>
                <label for="depart_station" class="block text-sm font-medium text-gray-700 mb-2">
                    Station de départ <span class="text-red-500">*</span>
                </label>
                <input type="text" id="search_depart" placeholder="Rechercher une station..."
                       class="mb-2 w-full rounded-lg border border-gray-300 px-4 py-2 focus:border-brand-500 focus:ring-brand-500" />
                <select name="depart_station" id="depart_station" required
                        class="w-full rounded-lg border border-gray-300 px-4 py-2 focus:border-brand-500 focus:ring-brand-500">
                    <option value="">-- Sélectionnez une station --</option>
                    {% for station in stations %}
                    <option value="{{ station.station }}">{{ station.nom }} ({{ station.adresse|default:"Pas d'adresse" }})</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Station d'arrivée -->
            <div>
                <label for="arrivee_station" class="block text-sm font-medium text-gray-700 mb-2">
                    Station d'arrivée <span class="text-red-500">*</span>
                </label>
                <input type="text" id="search_arrivee" placeholder="Rechercher une station..."
                       class="mb-2 w-full rounded-lg border border-gray-300 px-4 py-2 focus:border-brand-500 focus:ring-brand-500" />
                <select name="arrivee_station" id="arrivee_station" required
                        class="w-full rounded-lg border border-gray-300 px-4 py-2 focus:border-brand-500 focus:ring-brand-500">
                    <option value="">-- Sélectionnez une station --</option>
                    {% for station in stations %}
                    <option value="{{ station.station }}">{{ station.nom }} ({{ station.adresse|default:"Pas d'adresse" }})</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Véhicule (optionnel) -->
            <div>
                <label for="vehicule" class="block text-sm font-medium text-gray-700 mb-2">
                    Véhicule <span class="text-gray-400">(optionnel)</span>
                </label>
                <select name="vehicule" id="vehicule"
                        class="w-full rounded-lg border border-gray-300 px-4 py-2 focus:border-brand-500 focus:ring-brand-500">
                    <option value="">-- Aucun véhicule --</option>
                    {% for vehicule in vehicules %}
                    <option value="{{ vehicule.vehicule }}">{{ vehicule.nom }} ({{ vehicule.matricule|default:"Pas de matricule" }})</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Heure de départ -->
            <div>
                <label for="heure_depart" class="block text-sm font-medium text-gray-700 mb-2">
                    Heure de départ <span class="text-gray-400">(optionnel)</span>
                </label>
                <input type="datetime-local" name="heure_depart" id="heure_depart"
                       class="w-full rounded-lg border border-gray-300 px-4 py-2 focus:border-brand-500 focus:ring-brand-500">
                <p class="mt-1 text-sm text-gray-500">Format: AAAA-MM-JJ HH:MM</p>
            </div>

            <!-- Heure d'arrivée -->
            <div>
                <label for="heure_arrivee" class="block text-sm font-medium text-gray-700 mb-2">
                    Heure d'arrivée <span class="text-gray-400">(optionnel)</span>
                </label>
                <input type="datetime-local" name="heure_arrivee" id="heure_arrivee"
                       class="w-full rounded-lg border border-gray-300 px-4 py-2 focus:border-brand-500 focus:ring-brand-500">
                <p class="mt-1 text-sm text-gray-500">Format: AAAA-MM-JJ HH:MM</p>
            </div>

            <!-- Distance -->
            <div>
                <label for="distance" class="block text-sm font-medium text-gray-700 mb-2">
                    Distance (km) <span class="text-gray-400">(optionnel)</span>
                </label>
                <input type="number" step="0.1" name="distance" id="distance"
                       class="w-full rounded-lg border border-gray-300 px-4 py-2 focus:border-brand-500 focus:ring-brand-500"
                       placeholder="Ex: 25.5">
            </div>

            <!-- Durée -->
            <div>
                <label for="duree" class="block text-sm font-medium text-gray-700 mb-2">
                    Durée (heures) <span class="text-gray-400">(optionnel)</span>
                </label>
                <input type="number" step="0.1" name="duree" id="duree"
                       class="w-full rounded-lg border border-gray-300 px-4 py-2 focus:border-brand-500 focus:ring-brand-500"
                       placeholder="Ex: 1.5">
            </div>

            <!-- Buttons -->
            <div class="flex items-center justify-end space-x-4 pt-4">
                <a href="{% url 'accounts:trajets_list' %}" 
                   class="inline-flex items-center justify-center rounded-lg border border-gray-300 bg-white px-5 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50">
                    Annuler
                </a>
                <button type="submit"
                        class="inline-flex items-center justify-center rounded-lg bg-brand-600 px-5 py-2.5 text-sm font-medium text-white hover:bg-brand-700 focus:outline-none focus:ring-2 focus:ring-brand-500">
                    <i class="fas fa-save mr-2"></i> {{ submit_label }}
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
  const departInput = document.getElementById('search_depart');
  const departSelect = document.getElementById('depart_station');
  const arriveeInput = document.getElementById('search_arrivee');
  const arriveeSelect = document.getElementById('arrivee_station');

  async function fetchStations(q) {
    const url = new URL(window.location.origin + '/ai/stations/suggest/');
    if (q) url.searchParams.set('q', q);
    try {
      const res = await fetch(url.toString(), { headers: { 'Accept': 'application/json' } });
      const data = await res.json();
      return Array.isArray(data.stations) ? data.stations : [];
    } catch (e) {
      return [];
    }
  }

  function rebuildOptions(selectEl, stations) {
    const current = selectEl.value;
    selectEl.innerHTML = '';
    const def = document.createElement('option');
    def.value = '';
    def.textContent = '-- Sélectionnez une station --';
    selectEl.appendChild(def);
    stations.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.station;
      const name = s.nom || 'Sans nom';
      const addr = s.adresse || "Pas d'adresse";
      opt.textContent = `${name} (${addr})`;
      selectEl.appendChild(opt);
    });
    // conserver la sélection si toujours présente
    if ([...selectEl.options].some(o => o.value === current)) {
      selectEl.value = current;
    }
  }

  let departTimer = null;
  departInput && departInput.addEventListener('input', () => {
    clearTimeout(departTimer);
    const q = departInput.value.trim();
    departTimer = setTimeout(async () => {
      const stations = await fetchStations(q);
      rebuildOptions(departSelect, stations);
    }, 250);
  });

  let arriveeTimer = null;
  arriveeInput && arriveeInput.addEventListener('input', () => {
    clearTimeout(arriveeTimer);
    const q = arriveeInput.value.trim();
    arriveeTimer = setTimeout(async () => {
      const stations = await fetchStations(q);
      rebuildOptions(arriveeSelect, stations);
    }, 250);
  });
})();
</script>
{% endblock %}
